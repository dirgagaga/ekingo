<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluasi Kerja Mingguan - Desa Rapak Lambur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-container {
            transition: all 0.3s ease-in-out;
        }
        .day-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .preview-image {
            max-height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .history-card {
            transition: transform 0.2s ease-in-out;
        }
        .history-card:hover {
            transform: translateY(-5px);
        }
         /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        
        <header class="text-center mb-8 bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center">
                <div></div>
                <div class="flex-grow">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Portal Evaluasi Kerja Mingguan</h1>
                    <p class="text-lg text-gray-600 mt-2">Desa Rapak Lambur</p>
                </div>
                <button id="logout-button" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-300">Logout</button>
            </div>
             <div class="mt-4 text-sm text-gray-500">
                <p>Login sebagai: <span id="display-username" class="font-mono bg-green-100 text-green-800 px-2 py-1 rounded"></span> | ID Sesi: <span id="user-id" class="font-mono bg-gray-200 px-2 py-1 rounded">Memuat...</span></p>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2">
                <div class="form-container bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6 border-b pb-4">Form Laporan Minggu Ini</h2>
                    <form id="evaluation-form">
                        <div class="space-y-8">
                            <div id="days-container" class="space-y-6">
                            </div>
                            <div class="pt-6 border-t">
                                 <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 disabled:bg-gray-400">
                                    Kirim Laporan Mingguan
                                </button>
                                <p id="submit-status" class="text-center mt-4 text-sm text-gray-600"></p>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg h-full">
                    <h2 class="text-2xl font-semibold mb-6 border-b pb-4">Riwayat Laporan Anda</h2>
                    <div id="history-container" class="space-y-4 max-h-[80vh] overflow-y-auto pr-2">
                        <p id="history-placeholder" class="text-gray-500 text-center py-10">Belum ada riwayat laporan.</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        const loggedInUser = sessionStorage.getItem('loggedInUser');
        if (!loggedInUser) {
            window.location.href = 'index.html';
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : 'null');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let db, auth, userId;

        const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];
        const daysContainer = document.getElementById('days-container');
        const evaluationForm = document.getElementById('evaluation-form');
        const submitButton = document.getElementById('submit-button');
        const submitStatus = document.getElementById('submit-status');
        const historyContainer = document.getElementById('history-container');
        const historyPlaceholder = document.getElementById('history-placeholder');
        const userIdElement = document.getElementById('user-id');
        const displayUsernameElement = document.getElementById('display-username');
        const logoutButton = document.getElementById('logout-button');

        function initialize() {
            displayUsernameElement.textContent = loggedInUser;

            logoutButton.addEventListener('click', () => {
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'index.html';
            });
            
            if (!firebaseConfig) {
                console.error("Firebase config not found.");
                submitStatus.textContent = "Error: Konfigurasi Firebase tidak ditemukan.";
                return;
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            setupAuthListener();
            renderForm();
            setupFormListener();
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    userIdElement.textContent = userId;
                    loadHistory(loggedInUser); 
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                    });
                }
            });
        }
        
        function renderForm() {
            daysContainer.innerHTML = '';
            days.forEach(day => {
                const dayId = day.toLowerCase();
                const card = document.createElement('div');
                card.className = 'day-card';
                card.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">${day}</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="text-${dayId}" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Kegiatan:</label>
                            <textarea id="text-${dayId}" name="text-${dayId}" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="photo-${dayId}" class="block text-sm font-medium text-gray-700 mb-1">Foto Dokumentasi:</label>
                            <input type="file" id="photo-${dayId}" name="photo-${dayId}" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <img id="preview-${dayId}" class="mt-4 w-full preview-image hidden" alt="Pratinjau Foto ${day}">
                        </div>
                    </div>
                `;
                daysContainer.appendChild(card);
            });
            attachImagePreviewListeners();
        }

        function attachImagePreviewListeners() {
            days.forEach(day => {
                const dayId = day.toLowerCase();
                const photoInput = document.getElementById(`photo-${dayId}`);
                const previewImg = document.getElementById(`preview-${dayId}`);

                photoInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                            previewImg.classList.remove('hidden');
                        }
                        reader.readAsDataURL(file);
                    } else {
                        previewImg.src = '';
                        previewImg.classList.add('hidden');
                    }
                });
            });
        }
        
        function setupFormListener() {
            evaluationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId || !loggedInUser) {
                    submitStatus.textContent = "Sesi tidak valid. Mohon login kembali.";
                    return;
                }

                submitButton.disabled = true;
                submitStatus.textContent = 'Mengirim data...';

                try {
                    const evaluationData = {
                        username: loggedInUser,
                        createdAt: new Date(),
                        weekStartDate: getMonday(new Date()).toISOString().split('T')[0],
                        days: {}
                    };
                    
                    const tasks = days.map(async (day) => {
                        const dayId = day.toLowerCase();
                        const text = document.getElementById(`text-${dayId}`).value;
                        const photoInput = document.getElementById(`photo-${dayId}`);
                        let photoBase64 = null;
                        if (photoInput.files[0]) {
                            photoBase64 = await toBase64(photoInput.files[0]);
                        }
                        evaluationData.days[dayId] = { text, photo: photoBase64 };
                    });

                    await Promise.all(tasks);
                    
                    const collectionRef = collection(db, "artifacts", appId, "evaluations", loggedInUser, "reports");
                    await addDoc(collectionRef, evaluationData);

                    submitStatus.textContent = 'Laporan berhasil dikirim!';
                    evaluationForm.reset();
                    document.querySelectorAll('.preview-image').forEach(img => img.classList.add('hidden'));

                } catch (error) {
                    console.error("Error submitting evaluation: ", error);
                    submitStatus.textContent = 'Terjadi kesalahan saat mengirim laporan.';
                } finally {
                    submitButton.disabled = false;
                    setTimeout(() => { submitStatus.textContent = ''; }, 5000);
                }
            });
        }
        
        function loadHistory(currentUsername) {
            const historyCollectionRef = collection(db, "artifacts", appId, "evaluations", currentUsername, "reports");
            const q = query(historyCollectionRef, where("username", "==", currentUsername));

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    historyPlaceholder.style.display = 'block';
                    historyContainer.innerHTML = '';
                    historyContainer.appendChild(historyPlaceholder);
                    return;
                }

                historyPlaceholder.style.display = 'none';
                historyContainer.innerHTML = '';
                
                const docs = snapshot.docs.sort((a,b) => b.data().createdAt.toDate() - a.data().createdAt.toDate());

                docs.forEach(doc => {
                    const data = doc.data();
                    const card = document.createElement('div');
                    card.className = 'history-card bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm';
                    
                    let dayDetailsHTML = '';
                    days.forEach(day => {
                        const dayId = day.toLowerCase();
                        const dayData = data.days[dayId];
                        if (dayData && (dayData.text || dayData.photo)) {
                           dayDetailsHTML += `
                                <div class="mt-2">
                                    <p class="font-semibold text-gray-700">${day}:</p>
                                    <p class="text-sm text-gray-600 whitespace-pre-wrap">${dayData.text || '<em>Tidak ada deskripsi.</em>'}</p>
                                    ${dayData.photo ? `<img src="${dayData.photo}" alt="Foto ${day}" class="mt-2 w-full preview-image">` : ''}
                                </div>
                           `;
                        }
                    });

                    card.innerHTML = `
                        <h4 class="font-bold text-lg text-blue-800">Laporan Minggu ${data.weekStartDate}</h4>
                        <p class="text-xs text-gray-500 mb-2">Dikirim pada: ${data.createdAt.toDate().toLocaleString('id-ID')}</p>
                        <div class="mt-2 space-y-2 text-sm">${dayDetailsHTML}</div>
                    `;
                    historyContainer.appendChild(card);
                });
            }, (error) => {
                console.error("Error loading history: ", error);
            });
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay(),
                diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        initialize();
    </script>

</body>
</html>

